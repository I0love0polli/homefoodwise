# Attiva il motore di riscrittura
RewriteEngine On

# Imposta la base dell'URL alla radice del dominio.
RewriteBase /

# REGOLA DI SICUREZZA: Impedisce l'accesso diretto a cartelle sensibili
RewriteRule ^(vendor|database)/ - [F,L]

# ======================================================================
#             ORDINE DELLE REGOLE (DALLA PIÙ SPECIFICA ALLA PIÙ GENERICA)
# ======================================================================

# REGOLA 1: Se la richiesta è per un file o una cartella che esiste già, fermati.
RewriteCond %{REQUEST_FILENAME} -f [OR]
RewriteCond %{REQUEST_FILENAME} -d
RewriteRule ^ - [L]


# --- REGOLE PER LA DASHBOARD ---
# Vengono eseguite per prime perché "dashboard" è una parola chiave specifica.

# REGOLA 2A: Gestisce tutte le pagine della dashboard.
# Esempio: /dashboard/analitiche -> /dashboard/index.php?page=analitiche
RewriteRule ^dashboard/([a-zA-Z0-9_-]+)/?$ dashboard/index.php?page=$1 [L,QSA]

# REGOLA 2B: Se si visita solo "/dashboard", reindirizza a "/dashboard/home"
RewriteRule ^dashboard/?$ /dashboard/home [R=301,L]


# --- REGOLE PER LE PAGINE STATICHE ---
# REGOLA 3: Gestisce pagine come /login, /signup, etc.
RewriteRule ^(login|signup|restaurant|logout)/?$ $1/index.php [L]


# --- REGOLE PER L'APP CLIENTE (quelle che creavano il loop) ---

# REGOLA 4: Gestisce le pagine del ristorante (menu, carrello...).
# La condizione 'RewriteCond' è la correzione chiave: impedisce a questa regola
# di attivarsi se l'URL inizia con una delle nostre parole chiave (dashboard, login, etc.)
RewriteCond %{REQUEST_URI} !^/(dashboard|login|signup|restaurant|logout|app|assets|database)/
RewriteRule ^([a-zA-Z0-9_-]+)/([a-zA-Z0-9_-]+)/?$ app/index.php?ristorante=$1&page=$2 [L,QSA]

# REGOLA 5: Reindirizza la pagina principale di un ristorante al suo menu.
# Anche questa ha la condizione di sicurezza per evitare conflitti.
RewriteCond %{REQUEST_URI} !^/(dashboard|login|signup|restaurant|logout|app|assets|database)/
RewriteRule ^([a-zA-Z0-9_-]+)/?$ /$1/menu [R=301,L]


# --- REGOLA PER LA HOMEPAGE ---

# REGOLA 6: Gestisce la homepage principale del sito.
RewriteRule ^$ index.php [L]